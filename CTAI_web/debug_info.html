<!DOCTYPE html>
<html>
<head>
    <title>CTAI 调试信息</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #409EFF; }
        .success { color: green; }
        .error { color: red; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>CTAI 系统调试信息</h1>
    
    <div class="section">
        <h3>1. localStorage 检查</h3>
        <div id="storage-info"></div>
    </div>
    
    <div class="section">
        <h3>2. 后端连接测试</h3>
        <button onclick="testBackend()">测试后端连接</button>
        <div id="backend-info"></div>
    </div>
    
    <div class="section">
        <h3>3. Token 认证测试</h3>
        <button onclick="testAuth()">测试认证</button>
        <div id="auth-info"></div>
    </div>

    <script>
        // 检查 localStorage
        function checkStorage() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            const expireTime = localStorage.getItem('token_expire_time');
            
            let html = '';
            if (token) {
                html += `<p class="success">✓ Token: <code>${token.substring(0, 20)}...</code></p>`;
            } else {
                html += `<p class="error">✗ Token 不存在</p>`;
            }
            
            if (userInfo) {
                html += `<p class="success">✓ 用户信息: <code>${userInfo}</code></p>`;
            } else {
                html += `<p class="error">✗ 用户信息不存在</p>`;
            }
            
            if (expireTime) {
                const expire = new Date(expireTime);
                const now = new Date();
                const diff = expire - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                html += `<p class="success">✓ 过期时间: <code>${expireTime}</code> (剩余 ${hours} 小时)</p>`;
            } else {
                html += `<p class="error">✗ 过期时间不存在</p>`;
            }
            
            document.getElementById('storage-info').innerHTML = html;
        }
        
        // 测试后端连接
        async function testBackend() {
            const info = document.getElementById('backend-info');
            info.innerHTML = '<p>测试中...</p>';
            
            try {
                const response = await fetch('http://127.0.0.1:5003/api/patient');
                const data = await response.json();
                info.innerHTML = `<p class="success">✓ 后端连接成功！状态: ${response.status}</p>`;
            } catch (error) {
                info.innerHTML = `<p class="error">✗ 后端连接失败: ${error.message}</p>`;
            }
        }
        
        // 测试认证
        async function testAuth() {
            const info = document.getElementById('auth-info');
            info.innerHTML = '<p>测试中...</p>';
            
            const token = localStorage.getItem('token');
            if (!token) {
                info.innerHTML = '<p class="error">✗ 没有 Token，无法测试认证</p>';
                return;
            }
            
            try {
                const response = await fetch('http://127.0.0.1:5003/api/check-auth', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.status === 1) {
                    info.innerHTML = `<p class="success">✓ 认证成功！用户: ${data.data.username} (${data.data.name})</p>`;
                } else {
                    info.innerHTML = `<p class="error">✗ 认证失败: ${data.error}</p>`;
                }
            } catch (error) {
                info.innerHTML = `<p class="error">✗ 认证请求失败: ${error.message}</p>`;
            }
        }
        
        // 页面加载时执行
        checkStorage();
    </script>
</body>
</html>
